@namespace PutDoc.Components
@inject PutDoc.Services.PutDocState State
@using PutDoc.Services

<div class="pd-inline-toolbar @(open ? "open" : null)">
    <button type="button" class="pd-gear" @onclick="Toggle" title="Actions">⋯</button>

    @if (open)
    {
        <div class="pd-toolbar-row">
            <button type="button" title="Copy HTML" @onclick='Copy'>Copy</button>
            <button type="button" title="Edit fragment (inner)" @onclick='EditInner'>Edit</button>
            <button type="button" title="Edit element (outer)" @onclick='EditOuter'>Edit Outer</button>
            <button type="button" title="Clone" @onclick='() => Apply("clone")'>Clone</button>
            <button type="button" class="danger" title="Delete" @onclick='() => Apply("delete")'>Del</button>
            <button type="button" title="Move up" @onclick='() => Apply("up")'>↑</button>
            <button type="button" title="Move down" @onclick='() => Apply("down")'>↓</button>
        </div>
    }
</div>

@code {
    [Parameter] public Guid SnippetId { get; set; }
    [Parameter] public string? Puid { get; set; }    // data-puid value
    [Parameter] public string? Kind { get; set; }    // "slf-card"/"prompt_area"/...

    bool open;
    void Toggle() => open = !open;

    async Task EditInner()
    {
        if (string.IsNullOrEmpty(Puid)) return;
        await State.BeginFragmentEdit(SnippetId, Puid!, PutDocState.FragmentScope.Inner);
        await JS.InvokeVoidAsync("putdocEnh.markSelected", Puid);
    }

    async Task EditOuter()
    {
        if (string.IsNullOrEmpty(Puid)) return;
        await State.BeginFragmentEdit(SnippetId, Puid!, PutDocState.FragmentScope.Outer);
        await JS.InvokeVoidAsync("putdocEnh.markSelected", Puid);
    }

    async Task Copy()
    {
        if (string.IsNullOrEmpty(Puid)) return;
        await JS.InvokeVoidAsync("putdocEnh.copyByPuid", Puid);
    }

    async Task Apply(string action)
    {
        if (string.IsNullOrEmpty(Puid)) return;
        var ok = await HtmlTransformService.ApplyAsync(State, SnippetId, action, Puid!);
        if (ok) await State.SetSnippetHtml(State.CurrentSnippet()?.Html ?? "", isRawFromEditor: false);
    }

    [Inject] IJSRuntime JS { get; set; } = default!;
}