@namespace PutDoc.Components
@inject PutDocState State
@inject IJSRuntime JS

<h3 class="font-semibold mb-2">WorkPane — Snippets in Page</h3>

@if (State.CurrentPage() is { } _page)
{
    <div class="mb-2"><strong>Page:</strong> @_page.Title</div>

    @foreach (var snip in _page.Snippets)
    {
        <div @key="snip.Id" style="border:1px solid #ddd; border-radius:.5rem; margin-bottom:.75rem;">
            <div style="padding:.75rem; background:#f8f8f8;">
                <div class="workpane-snippet"
                     id="@($"snip-{snip.Id}")"
                     data-snippet-id="@snip.Id">
                    @((MarkupString)(snip.Html ?? ""))
                </div>
            </div>

            <div style="padding:.5rem; display:flex; gap:.5rem; border-top:1px solid #eee;">
                <button type='button' class='btn' @onclick='() => State.AddSnippetBelow(snip.Id)'>＋</button>
                <button type='button' class='btn' @onclick='() => State.DeleteSnippet(snip.Id)'>Delete</button>
                <button type='button' class='btn' @onclick='() => State.CloneSnippet(snip.Id)'>Clone</button>
                <button type='button' class='btn' @onclick='() => CopyToClipboard(snip.Html ?? "")'>Copy</button>
                <button type='button' class='btn' @onclick='() => State.MoveSnippet(snip.Id, -1)'>↑</button>
                <button type='button' class='btn' @onclick='() => State.MoveSnippet(snip.Id, +1)'>↓</button>

                <button type='button'
                        class='btn @(State.SelectedSnippetId == snip.Id ? "font-bold" : "")'
                        @onclick='() => State.SelectSnippet(snip.Id)'>
                    Edit
                </button>

                <button type='button' class='btn' @onclick='() => InsertTemplate(snip.Id, TemplateKind.Card)'>+ slf-card</button>
                <button type='button' class='btn' @onclick='() => InsertTemplate(snip.Id, TemplateKind.Brick)'>+ slf-brick</button>
                <button type='button' class='btn' @onclick='() => InsertTemplate(snip.Id, TemplateKind.Prompt)'>+ prompt</button>
            </div>
        </div>
    }

    <div>
        <button type="button" class="btn" @onclick="() => State.AddSnippetBelow(_page.Snippets.LastOrDefault()?.Id ?? Guid.Empty)">
            ＋ Add snippet
        </button>
    </div>
}
else
{
    <p style="color:#666;font-style:italic">Select a page from Index.</p>
}

<style>
.btn { padding:.25rem .5rem; border:1px solid #ccc; border-radius:.375rem; background:#fff; cursor:pointer; }
.btn:hover { background:#f4f4f4; }
.font-bold { font-weight:700; }
</style>

@code {
    enum TemplateKind { Card, Brick, Prompt }

    async Task CopyToClipboard(string html) =>
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", html);

    async Task InsertTemplate(Guid snippetId, TemplateKind kind)
    {
        var page = State.CurrentPage(); if (page is null) return;
        var snip = page.Snippets.FirstOrDefault(s => s.Id == snippetId); if (snip is null) return;

        var add = kind switch
        {
            TemplateKind.Card   => """<div class="slf-card"><h3>Title</h3><p><b>Purpose</b>: <span>…</span></p><div><b>Content</b>: <div>…</div></div></div>""",
            TemplateKind.Brick  => """<div class="slf-brick"><h3>BRICK</h3><p><b>Definition</b>: <span>…</span></p><div><b>Example</b>: <div>…</div></div></div>""",
            TemplateKind.Prompt => """<div class="prompt_area"><h3>Prompt</h3><p>…</p></div>""",
            _ => ""
        };

        await State.SetSnippetHtml((snip.Html ?? "") + "\n" + add, isRawFromEditor: false);
        State.SelectSnippet(snippetId);
    }

    protected override void OnInitialized() => State.Changed += OnStateChanged;
    void OnStateChanged() => _ = InvokeAsync(StateHasChanged);
    public void Dispose() => State.Changed -= OnStateChanged;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Enhance each snippet by its DOM id
        var page = State.CurrentPage(); if (page is null) return;
        foreach (var snip in page.Snippets)
        {
            var domId = $"snip-{snip.Id}";
            await JS.InvokeVoidAsync("putdocEnh.observeById", domId);
        }
    }
}
