@namespace PutDoc.Components
@inject PutDoc.Services.PutDocState State
@inject IJSRuntime JS

<h3 class="font-semibold mb-2">Index</h3>

@if (Root is not null)
{
    <div class="text-sm">
        @RenderLeaf(Root)
    </div>
}
else { <em>Missing root leaf.</em> }

@code {
    // one open menu (leaf or page) at a time
    Guid? _menuOpenFor;

    Leaf? Root => State.Doc.Leafs.TryGetValue(State.Doc.RootLeafId, out var l) ? l : null;

    void ToggleMenuFor(Guid id) => _menuOpenFor = (_menuOpenFor == id) ? null : id;

    //Dictionary<bool, string> up_dn = new Dictionary<bool, string>() { { true, "‚ñ≥" }, {false, "‚ñΩ"} };
    Dictionary<bool, string> up_dn = new Dictionary<bool, string>() { { true, "‚ñ≤" }, {false, "‚ñº"} };
    
    RenderFragment RenderLeaf(Leaf leaf) => __builder =>
    {
        <details open class="leaf">
            <summary class="leaf-row">
                <button class="btn drop" @onclick="() => ToggleMenuFor(leaf.Id)">
                    @(up_dn[_menuOpenFor == leaf.Id])
                </button>
                <span>üìÅ</span>
                <input value="@leaf.Title"
                       @onchange="(e => State.RenameLeaf(leaf.Id, e.Value?.ToString() ?? leaf.Title))"
                       class="leaf-title" />
            </summary>

            @if (_menuOpenFor == leaf.Id)
            {
                <div class="menu-popover">
                    <button class="btn" @onclick="() => State.CreatePage(leaf.Id)">+ Page</button>
                    <button class="btn" @onclick="() => State.CreateLeaf(leaf.Id)">+ Leaf</button>
                </div>
            }

            @if (leaf.ChildLeafIds?.Count > 0)
            {
                <div class="child-leafs">
                    @foreach (var cid in leaf.ChildLeafIds)
                    {
                        if (!State.Doc.Leafs.TryGetValue(cid, out var child)) continue;
                        @RenderLeaf(child)
                    }
                </div>
            }

            @if (leaf.PageIds?.Count > 0)
            {
                <ul class="page-list">
                    @foreach (var pid in leaf.PageIds)
                    {
                        if (!State.Doc.Pages.TryGetValue(pid, out var p)) continue;
                        var active = State.SelectedPageId == pid;
                        <li class="page-item @(active ? "active" : null)">
                            <div class="page-row">
                                <button class="btn drop" @onclick="() => ToggleMenuFor(pid)">
                                    @(up_dn[_menuOpenFor == pid])
                                </button>
                                <button class="page-link @(active ? "active" : null)"
                                        @onclick="() => State.SelectPage(pid)">
                                    üìÑ @p.Title
                                </button>
                            </div>

                            @if (_menuOpenFor == pid)
                            {
                                <div class="menu-popover">
                                    <button class="btn" title="Rename" @onclick="() => PromptRenamePage(pid, p.Title)">‚úé Rename</button>
                                    <button class="btn" title="Move Up" @onclick="() => State.MovePage(leaf.Id, pid, -1)">‚Üë</button>
                                    <button class="btn" title="Move Down" @onclick="() => State.MovePage(leaf.Id, pid, +1)">‚Üì</button>
                                    <button class="btn" title="Clone" @onclick="() => State.ClonePage(leaf.Id, pid)">‚ßâ Clone</button>
                                    <button class="btn danger" title="Delete" @onclick="() => State.DeletePage(leaf.Id, pid)">üóë Delete</button>
                                    <span class="sep"></span>
                                    <button class="btn primary" title="Paste HTML as new snippet" @onclick="() => PasteIntoPage(pid)">üìã Paste into Page</button>
                                </div>
                            }
                        </li>
                    }
                </ul>
            }
        </details>;
    };

    async Task PromptRenamePage(Guid pageId, string current)
    {
        var title = await JS.InvokeAsync<string>("prompt", "Rename page:", current);
        if (!string.IsNullOrWhiteSpace(title))
            await State.RenamePage(pageId, title);
    }

    async Task PasteIntoPage(Guid pageId)
    {
        var html = await JS.InvokeAsync<string>("putdoc.readClipboardText");
        if (string.IsNullOrWhiteSpace(html)) return;
        await State.AddSnippetToPage(pageId, html);   // selects new snippet & updates editor via Notify()
    }
}

<style>
.drop { min-width: 2rem; color: #8A8; }
.leaf { font-weight:700; background-color: rgba(196,196,128,0.2);
        border:2px dashed #444; border-radius:16px; padding:.25rem .5rem; }
.leaf-row { display:flex; align-items:center; gap:.5rem; }
.leaf-title { border:0; border-bottom:1px dashed #ccc; outline:none; background:transparent; width:14rem; }
.page-list { list-style:none; padding-left:1rem; margin:.25rem 0; }
.page-item { margin:.25rem 0; border-radius:.5rem; }
.page-item.active { font-weight:700; border:1px solid #333; background-color: rgba(196,128,96,0.2); }
.page-row { display:flex; align-items:center; gap:.35rem; }
.page-link { background:none; border:0; text-decoration:underline; cursor:pointer; }
.page-link.active { font-weight:700; text-decoration:none; }
.menu-popover { background-color:#ffc; border:1px solid #ccc; border-radius:.5rem; padding:.5rem; margin:.35rem 0; }
.sep { border-top:1px solid #ccc; margin:.5rem 0; display:block; }
.btn { padding:.15rem .5rem; border:1px solid #ccc; border-radius:.375rem; background:#fff; cursor:pointer; }
.btn:hover { background:#f4f4f4; }
.btn.primary { border-color:#5b9; }
.btn.danger { border-color:#c77; }
.child-leafs { margin-left:1rem; }
</style>
