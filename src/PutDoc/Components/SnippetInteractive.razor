@namespace PutDoc.Components
@inject IJSRuntime JS
@inject PutDoc.Services.PutDocState State
@using PutDoc.Services

<div @ref="_root">
    @((MarkupString)Html)
</div>

@code {
    [Parameter] public string Html { get; set; } = "";
    [Parameter] public Guid SnippetId { get; set; }

    private ElementReference _root;
    private DotNetObjectReference<SnippetInteractive>? _selfRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        _selfRef ??= DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("putdocEnhance", _root, _selfRef);
    }

    [JSInvokable]
    public async Task OnDomAction(string action, string puid, string path)
    {
        State.SelectSnippet(SnippetId);
        await HtmlTransformService.ApplyAsync(State, SnippetId, action, puid, path);
    }

    public void Dispose() => _selfRef?.Dispose();
}